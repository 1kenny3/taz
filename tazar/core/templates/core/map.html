{% extends 'core/base.html' %}
{% load static %}

{% block title %}Карта пунктов сбора и мусора - TAZAR{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/map.css' %}">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Заголовок -->
    <div class="text-center mb-8 animate-slide-in">
        <h1 class="text-4xl font-extrabold mb-4 text-gray-800">
            <i class="fas fa-map-marked-alt text-green-500 mr-3"></i>
            Экологическая карта
        </h1>
        <p class="text-gray-600 text-lg max-w-2xl mx-auto">
            Интерактивная карта пунктов сбора отходов и мест, требующих уборки. 
            Вместе мы делаем наш город чище!
        </p>
    </div>

    <!-- Переключатель режимов отображения -->
    <div class="mb-6 flex justify-center animate-slide-in" style="animation-delay: 0.1s">
        <div class="view-toggle">
            <button 
                onclick="showMapView()" 
                id="map-toggle-btn" 
                class="active flex items-center space-x-2"
            >
                <i class="fas fa-map-marked-alt"></i>
                <span>Карта</span>
            </button>
            <button 
                onclick="showListView()" 
                id="list-toggle-btn" 
                class="flex items-center space-x-2"
            >
                <i class="fas fa-list"></i>
                <span>Список</span>
            </button>
        </div>
    </div>
    
    <!-- Контейнер для карты -->
    <div class="map-container animate-slide-in" style="animation-delay: 0.2s">
        <div id="map" class="w-full rounded-xl"></div>
    </div>
    
    <!-- Панель управления -->
    <div class="controls-panel mt-6 p-6 animate-slide-in" style="animation-delay: 0.3s">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Легенда карты -->
            <div>
                <div class="legend-section">
                    <h3 class="legend-title">
                        <i class="fas fa-info-circle text-green-500 mr-2"></i>
                        Легенда карты
                    </h3>
                    <div class="legend-items-container">
                        <div class="legend-item">
                            <div class="legend-marker bg-green-500"></div>
                            <span class="legend-text">Пункты сбора</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker bg-black"></div>
                            <span class="legend-text">Новые сообщения</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker bg-blue-500"></div>
                            <span class="legend-text">В обработке</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker bg-orange-500"></div>
                            <span class="legend-text">Убранный мусор</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Фильтры -->
            <div class="filters-section">
                <h3 class="filters-title text-lg font-semibold flex items-center text-gray-800">
                    <i class="fas fa-filter text-green-500 mr-2"></i>
                    Фильтр по типу отходов
                </h3>
                <div class="flex flex-wrap gap-2">
                    <button onclick="filterMarkers('plastic')" class="filter-button" data-type="plastic">
                        <div class="filter-icon bg-blue-500"></div>
                        <span>Пластик</span>
                    </button>
                    <button onclick="filterMarkers('paper')" class="filter-button" data-type="paper">
                        <div class="filter-icon bg-green-500"></div>
                        <span>Бумага</span>
                    </button>
                    <button onclick="filterMarkers('metal')" class="filter-button" data-type="metal">
                        <div class="filter-icon bg-yellow-500"></div>
                        <span>Металл</span>
                    </button>
                    <button onclick="filterMarkers('glass')" class="filter-button" data-type="glass">
                        <div class="filter-icon bg-red-500"></div>
                        <span>Стекло</span>
                    </button>
                    <button onclick="filterMarkers('medical')" class="filter-button" data-type="medical">
                        <div class="filter-icon bg-pink-500"></div>
                        <span>Медицинские</span>
                    </button>
                    <button onclick="filterMarkers('construction')" class="filter-button" data-type="construction">
                        <div class="filter-icon bg-orange-500"></div>
                        <span>Строительные</span>
                    </button>
                    <button onclick="filterMarkers('agricultural')" class="filter-button" data-type="agricultural">
                        <div class="filter-icon bg-lime-500"></div>
                        <span>Сельские</span>
                    </button>
                    <button onclick="showAllMarkers()" class="action-button">
                        <i class="fas fa-globe mr-2"></i>
                        Все
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Список пунктов сбора -->
    <div id="points-list-container" class="hidden mt-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for point in points_list %}
                <div class="point-card animate-fade-in" data-waste-type="{{ point.waste_types }}">
                    <div class="flex items-center mb-4">
                        <div class="point-type-indicator" 
                            style="background-color: {% if point.waste_types == 'plastic' %}#3B82F6{% elif point.waste_types == 'paper' %}#10B981{% elif point.waste_types == 'metal' %}#F59E0B{% elif point.waste_types == 'glass' %}#EF4444{% else %}#9CA3AF{% endif %};">
                        </div>
                        <h3 class="font-bold text-lg text-gray-800">{{ point.address }}</h3>
                    </div>
                    <div class="space-y-2 mb-4">
                        <p class="text-gray-600">
                            <i class="fas fa-city mr-2"></i>
                            {{ point.city }}
                        </p>
                        <p class="text-gray-600">
                            <i class="fas fa-recycle mr-2"></i>
                            {{ point.get_waste_types_display }}
                        </p>
                    </div>
                    <button 
                        onclick="moveToLocation({{ point.latitude }}, {{ point.longitude }})"
                        class="action-button w-full"
                    >
                        <i class="fas fa-map-marker-alt mr-2"></i>
                        Показать на карте
                    </button>
                </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Индикатор загрузки -->
    <div id="loading" class="loading-overlay fixed inset-0 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-2xl shadow-xl flex flex-col items-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-gray-700 font-medium">Загрузка карты...</p>
        </div>
    </div>
</div>

<!-- Скрипт Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>

<script>
    // Глобальные переменные
    let map;
    let markers = [];
    let trashMarkers = [];
    let currentFilter = null;
    
    // Показать индикатор загрузки
    document.getElementById('loading').style.display = 'flex';

    // Функция инициализации карты
    function initMap() {
        console.log("Инициализация карты...");
        
        // Определяем центр карты (Бишкек по умолчанию)
        var mapCenter = {lat: 42.8746, lng: 74.5698};
        
        // Создаем карту с улучшенными настройками
        map = new google.maps.Map(document.getElementById('map'), {
            center: mapCenter,
            zoom: 12,
            styles: [
                {
                    "featureType": "poi",
                    "elementType": "labels",
                    "stylers": [{ "visibility": "off" }]
                },
                {
                    "featureType": "transit",
                    "elementType": "labels",
                    "stylers": [{ "visibility": "off" }]
                }
            ],
            mapTypeControl: true,
            mapTypeControlOptions: {
                style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                position: google.maps.ControlPosition.TOP_RIGHT
            },
            fullscreenControl: true,
            streetViewControl: true,
            zoomControl: true,
            zoomControlOptions: {
                position: google.maps.ControlPosition.RIGHT_CENTER
            },
        });
        
        // Добавляем пункты сбора отходов
        var collectionPoints = {{ collection_points|safe }};
        console.log("Пункты сбора:", collectionPoints);
        
        if (collectionPoints && collectionPoints.length > 0) {
            collectionPoints.forEach(function(point) {
                // Создаем маркер с улучшенным дизайном
                const marker = new google.maps.Marker({
                    position: {lat: point.latitude, lng: point.longitude},
                    map: map,
                    title: point.address,
                    waste_type: point.waste_types,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: getWasteTypeColor(point.waste_types),
                        fillOpacity: 1,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 2,
                        scale: 10
                    },
                    animation: google.maps.Animation.DROP
                });
                
                markers.push(marker);
                
                // Создаем улучшенное информационное окно
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div class="p-4 max-w-sm">
                            <h3 class="text-lg font-bold mb-2">${point.address}</h3>
                            <div class="space-y-2 mb-4">
                                <p class="flex items-center text-gray-600">
                                    <i class="fas fa-city mr-2"></i>
                                    ${point.city}
                                </p>
                                <p class="flex items-center text-gray-600">
                                    <i class="fas fa-recycle mr-2"></i>
                                    ${point.waste_types_display}
                                </p>
                            </div>
                            <div class="flex justify-center">
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${point.latitude},${point.longitude}" 
                                   target="_blank" 
                                   class="action-button text-sm">
                                   <i class="fas fa-directions mr-2"></i>
                                   Построить маршрут
                                </a>
                            </div>
                        </div>
                    `
                });
                
                marker.addListener('click', function() {
                    infoWindow.open(map, marker);
                });
            });
            
            // Центрируем карту на всех маркерах
            const bounds = new google.maps.LatLngBounds();
            markers.forEach(marker => bounds.extend(marker.getPosition()));
            map.fitBounds(bounds);
        }
        
        // Добавляем отчеты о мусоре
        var trashReports = {{ trash_reports|safe }};
        console.log("Отчеты о мусоре:", trashReports);
        
        if (trashReports && trashReports.length > 0) {
            let delay = 0;
            
            trashReports.forEach(function(report) {
                setTimeout(() => {
                    const marker = new google.maps.Marker({
                        position: {lat: report.latitude, lng: report.longitude},
                        map: map,
                        title: report.address,
                        report_status: report.status,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8.5,
                            fillColor: getStatusColor(report.status),
                            fillOpacity: 1,
                            strokeColor: '#FFFFFF',
                            strokeWeight: 2
                        },
                        animation: google.maps.Animation.DROP
                    });

                    trashMarkers.push(marker);

                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div class="p-4 max-w-sm">
                                <h3 class="text-lg font-bold mb-2">${report.address}</h3>
                                <div class="space-y-2 mb-4">
                                    <p class="flex items-center text-gray-600">
                                        <i class="fas fa-calendar mr-2"></i>
                                        ${report.created_at}
                                    </p>
                                    <p class="flex items-center text-gray-600">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        ${report.description}
                                    </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-check-circle mr-2"></i>
                                        <span class="px-2 py-1 rounded-full text-sm font-medium
                                            ${getStatusClass(report.status)}">
                                            ${getStatusText(report.status)}
                                        </span>
                                    </p>
                                </div>
                                ${report.photo ? `
                                    <div class="mb-4">
                                        <img src="${report.photo}" alt="Фото мусора" class="w-full rounded-lg shadow">
                                    </div>
                                ` : ''}
                                <div class="flex justify-center">
                                    <a href="https://www.google.com/maps/dir/?api=1&destination=${report.latitude},${report.longitude}" 
                                       target="_blank" 
                                       class="action-button text-sm">
                                       <i class="fas fa-directions mr-2"></i>
                                       Построить маршрут
                                    </a>
                                </div>
                            </div>
                        `
                    });

                    marker.addListener('click', function() {
                        infoWindow.open(map, marker);
                    });
                }, delay);
                delay += 100;
            });
        }

        // Скрываем индикатор загрузки
        document.getElementById('loading').style.display = 'none';
    }

    // Вспомогательные функции
    function getWasteTypeColor(type) {
        const colors = {
            'plastic': '#3B82F6',
            'paper': '#10B981',
            'metal': '#F59E0B',
            'glass': '#EF4444',
            'medical': '#EC4899',
            'construction': '#F97316',
            'agricultural': '#84CC16'
        };
        return colors[type] || '#9CA3AF';
    }

    function getStatusColor(status) {
        const colors = {
            'new': '#000000',
            'in_progress': '#3B82F6',
            'completed': '#F97316',
            'rejected': '#EF4444'
        };
        return colors[status] || '#000000';
    }

    function getStatusClass(status) {
        const classes = {
            'new': 'bg-gray-100 text-gray-800',
            'in_progress': 'bg-blue-100 text-blue-800',
            'completed': 'bg-green-100 text-green-800',
            'rejected': 'bg-red-100 text-red-800'
        };
        return classes[status] || 'bg-gray-100 text-gray-800';
    }

    function getStatusText(status) {
        const texts = {
            'new': 'Новое',
            'in_progress': 'В обработке',
            'completed': 'Убрано',
            'rejected': 'Отклонено'
        };
        return texts[status] || 'Неизвестно';
    }

    // Функции для фильтрации
    function filterMarkers(type) {
        currentFilter = type;
        
        // Обновляем активный класс кнопок
        document.querySelectorAll('.filter-button').forEach(button => {
            if (button.dataset.type === type) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });

        markers.forEach(marker => {
            marker.setVisible(marker.waste_type === type);
        });

        // Обновляем список точек
        document.querySelectorAll('.point-card').forEach(card => {
            if (card.dataset.wasteType === type) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    function showAllMarkers() {
        currentFilter = null;
        
        // Сбрасываем активный класс всех кнопок
        document.querySelectorAll('.filter-button').forEach(button => {
            button.classList.remove('active');
        });

        markers.forEach(marker => {
            marker.setVisible(true);
        });

        // Показываем все точки в списке
        document.querySelectorAll('.point-card').forEach(card => {
            card.style.display = 'block';
        });
    }

    // Функции для переключения видов
    function showMapView() {
        document.getElementById('map-toggle-btn').classList.add('active');
        document.getElementById('list-toggle-btn').classList.remove('active');
        document.querySelector('.map-container').style.display = 'block';
        document.getElementById('points-list-container').style.display = 'none';
    }

    function showListView() {
        document.getElementById('map-toggle-btn').classList.remove('active');
        document.getElementById('list-toggle-btn').classList.add('active');
        document.querySelector('.map-container').style.display = 'none';
        document.getElementById('points-list-container').style.display = 'block';
    }

    function moveToLocation(lat, lng) {
        showMapView();
        map.setCenter({lat: lat, lng: lng});
        map.setZoom(16);
    }
</script>
{% endblock %}