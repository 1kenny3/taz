{% extends 'core/base.html' %}
{% load static %}
{% load dashboard_tags %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - TAZAR{% endblock %}

{% block content %}
<div class="container mx-auto mt-10">
    <div class="grid md:grid-cols-4 gap-6">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ü—Ä–æ—Ñ–∏–ª—å -->
        <div class="md:col-span-1">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="text-center mb-6">
                    {% if user.profile_photo %}
                        <img src="{{ user.profile_photo.url }}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è" 
                             class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-4 border-green-500">
                    {% else %}
                        <div class="w-32 h-32 rounded-full mx-auto mb-4 bg-gray-200 flex items-center justify-center">
                            <span class="text-4xl text-gray-500">üë§</span>
                        </div>
                    {% endif %}
                    <h2 class="text-2xl font-bold">{{ user.username }}</h2>
                    <p class="text-gray-600">{{ user.email }}</p>
                    <p class="text-3xl font-bold text-green-600 mt-2">
                        {{ user.points }} –±–∞–ª–ª–æ–≤
                    </p>
                </div>

                <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
                <form method="POST" enctype="multipart/form-data" class="mt-6">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            –§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
                        </label>
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <input type="file" 
                                       name="{{ form.profile_photo.name }}" 
                                       id="{{ form.profile_photo.id_for_label }}"
                                       class="hidden" 
                                       accept="image/*">
                                <label for="{{ form.profile_photo.id_for_label }}" 
                                       class="cursor-pointer bg-white border border-gray-300 rounded-lg px-4 py-2 hover:bg-gray-50 transition duration-300 block text-center">
                                    –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ
                                </label>
                                <div id="selected-file" class="text-sm text-gray-600 mt-1"></div>
                            </div>
                            {% if user.profile_photo %}
                                <div class="flex items-center">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="clear_photo" class="form-checkbox text-red-500">
                                        <span class="ml-2 text-sm text-red-500">–£–¥–∞–ª–∏—Ç—å</span>
                                    </label>
                                </div>
                            {% endif %}
                        </div>
                        {% if form.profile_photo.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.profile_photo.errors }}</div>
                        {% endif %}
                    </div>
                    <div id="image-preview" class="mt-2 hidden">
                        <img src="" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" class="max-w-xs rounded-lg">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="{{ form.bio.id_for_label }}">
                            –û —Å–µ–±–µ
                        </label>
                        {{ form.bio }}
                        {% if form.bio.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.bio.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="{{ form.email.id_for_label }}">
                            Email
                        </label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.email.errors }}</div>
                        {% endif %}
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-300">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                </form>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="md:col-span-3">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <div class="text-3xl text-green-500 mb-2">{{ stats.total_reports }}</div>
                    <div class="text-gray-600">–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <div class="text-3xl text-green-500 mb-2">{{ stats.completed_reports }}</div>
                    <div class="text-gray-600">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <div class="text-3xl text-green-500 mb-2">{{ stats.total_points }}</div>
                    <div class="text-gray-600">–ë–∞–ª–ª–æ–≤ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <div class="text-3xl text-green-500 mb-2">{{ stats.reports_this_month }}</div>
                    <div class="text-gray-600">–°–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –º–µ—Å—è—Ü</div>
                </div>
            </div>

            <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold mb-4">–í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {% for achievement in achievements %}
                        <div class="p-4 rounded-lg {% if achievement in user_achievements %}bg-green-50 border-green-200{% else %}bg-gray-50 border-gray-200{% endif %} border">
                            <div class="text-3xl mb-2">{{ achievement.icon }}</div>
                            <div class="font-medium">{{ achievement.name }}</div>
                            <div class="text-sm text-gray-600">{{ achievement.description }}</div>
                            <div class="text-gray-500 text-sm mt-2">
                                {{ user.points }}/{{ achievement.points_required }} –±–∞–ª–ª–æ–≤
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold mb-4">–í–∞—à–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                <canvas id="activityChart"></canvas>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ –º—É—Å–æ—Ä–µ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4">–í–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –º—É—Å–æ—Ä–µ</h3>
                {% if user_reports %}
                    <div class="space-y-4">
                        {% for report in user_reports %}
                        <div class="border rounded-lg p-4 {% if report.status == 'completed' %}bg-green-50{% elif report.status == 'rejected' %}bg-red-50{% endif %}">
                            <div class="flex items-start">
                                {% if report.photo %}
                                    <img src="{{ report.photo.url }}" alt="–§–æ—Ç–æ –º—É—Å–æ—Ä–∞" class="w-24 h-24 rounded-lg object-cover mr-4">
                                {% endif %}
                                <div class="flex-1">
                                    <p class="font-medium">{{ report.address }}</p>
                                    <p class="text-sm text-gray-600">{{ report.description }}</p>
                                    <div class="mt-2 flex items-center justify-between">
                                        <span class="text-sm text-gray-500">{{ report.created_at|date:"d.m.Y H:i" }}</span>
                                        <span class="px-3 py-1 rounded-full text-sm 
                                            {% if report.status == 'new' %}bg-blue-100 text-blue-800
                                            {% elif report.status == 'in_progress' %}bg-yellow-100 text-yellow-800
                                            {% elif report.status == 'completed' %}bg-green-100 text-green-800
                                            {% else %}bg-red-100 text-red-800{% endif %}">
                                            {{ report.get_status_display }}
                                        </span>
                                    </div>
                                    {% if report.points_awarded %}
                                        <p class="text-sm text-green-600 mt-2">+{{ report.POINTS_FOR_COMPLETION }} –±–∞–ª–ª–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω–æ</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-600 text-center py-8">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –æ –º—É—Å–æ—Ä–µ</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤ –∫–æ–Ω–µ—Ü –±–ª–æ–∫–∞ content -->
{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('activityChart').getContext('2d');
const activityChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω'],
        datasets: [{
            label: '–°–æ–æ–±—â–µ–Ω–∏—è –æ –º—É—Å–æ—Ä–µ',
            data: [12, 19, 3, 5, 2, 3],
            borderColor: 'rgb(34, 197, 94)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>
{% endblock %}
{% endblock %} 